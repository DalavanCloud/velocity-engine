<?xml version="1.0"?>

<!-- Testcases for Velocity -->
<project name="main" default="test-all">

  <property name="build.dir" value="../bin"/>
  <property name="build.dest" value="${build.dir}/classes"/>
  <property name="ant.home" value="."/>
  <property name="test.home" value="../test"/>
  <property name="test.target" value="../target/test"/>
  <property name="junit.jar" value="lib/junit-3.8.1.jar"/>

  <!-- JUnit Testbed properties -->
  <property name="velocity.test.runner" value="junit.textui.TestRunner"/>

  <!-- Turns on/off overall failure if one test fails -->
 <property name="testbed.failonerror" value="true"/>

  <!-- Build classpath -->
  <path id="classpath">
    <fileset dir="./lib">
      <include name="**/*.jar"/>
    </fileset>
    <pathelement location="${build.dest}"/>
  </path>

  <!-- =================================================================== -->
  <!-- JUnit Test Cases                                                    -->
  <!-- =================================================================== -->
  <target name="test-clean">
    <!--
         Hack to prevent Ant from complaining about missing directories.
         This is fixed in Ant >1.3, but we are using Ant 1.3 now.
    -->
    <mkdir dir="${test.target}/anakia"/>
    <mkdir dir="${test.target}/configuration"/>
    <mkdir dir="${test.target}/cpload"/>
    <mkdir dir="${test.target}/multi"/>
    <mkdir dir="${test.target}/multiloader"/>
    <mkdir dir="${test.target}/templates"/>
    <mkdir dir="${test.target}/texen"/>
    <!--
         Delete the results directories
    -->
    <delete dir="${test.target}/anakia" quiet="true"/>
    <delete dir="${test.target}/configuration" quiet="true"/>
    <delete dir="${test.target}/cpload" quiet="true"/>
    <delete dir="${test.target}/multi" quiet="true"/>
    <delete dir="${test.target}/multiloader" quiet="true"/>
    <delete dir="${test.target}/templates" quiet="true"/>
    <delete dir="${test.target}/texen" quiet="true"/>
    <delete dir="${test.target}/resourceinstance" quiet="true"/>
  </target>

  <target name="test-all" depends="
                                   test-template,
                                   test-velocityapp,
                                   test-introspect,
                                   test-introspect2,
                                   test-introspect3,
                                   test-classloaderchange,
                                   test-inlinevmscope,
                                   test-multi,
                                   test-cpload,
                                   test-contextsafety,
                                   test-configuration,
                                   test-commonsextprop,
                                   test-externallogger,
                                   test-methodinvocationexception,
                                   test-multiloader,
                                   test-encoding,
                                   test-eventhandling,
                                   test-velocimacro,
                                   test-texen,
                                   test-texen-classpath,
                                   test-misc,
                                   test-parser,
                                   test-resourceinstance,
                                   test-foreach,
                                   test-arithmetic,
                                   test-number-methods,
                                   test-anakia,
                                   test-includeeventhandler,
                                   test-filteredeventhandler,
                                   test-builtineventhandler                                   
                                   "/>

  <target name="test-template">
    <echo message="Running Template tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".."
          failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.TemplateTestCase"/>
      <classpath refid="classpath"/>
    </java>
   </target>

 <target name="test-eventhandling">
    <echo message="Running Event Handler tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.EventHandlingTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
   </target>

  <target name="test-encoding">
    <echo message="Running Template encoding test..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.EncodingTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
   </target>

  <target name="test-velocityapp">
    <echo message="Running app.Velocity tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.VelocityAppTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-introspect">
    <echo message="Running Introspector tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.IntrospectorTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-introspect2">
    <echo message="Running Introspector2 tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.Introspector2TestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

    <target name="test-introspect3">
    <echo message="Running Introspector3 tests..."/>
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.Introspector3TestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>
  
  <target name="test-classloaderchange">
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}" >
      <arg value="org.apache.velocity.test.ClassloaderChangeTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-inlinevmscope">
    <echo message="Running Inline VM Scope tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}" >
      <arg value="org.apache.velocity.test.InlineScopeVMTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-multi">
    <echo message="Running Multiple File Resource Path tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.MultipleFileResourcePathTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-cpload">
    <echo message="Running Classpath Resource tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ClasspathResourceTestCase"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement location="${test.home}/cpload/test1.jar"/>
        <pathelement location="${test.home}/cpload/test2.jar"/>
      </classpath>
    </java>
  </target>

  <target name="test-contextsafety">
    <echo message="Running Context Safety tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ContextSafetyTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-anakia">
    <echo message="Running Anakia tests..."/>

    <taskdef name="anakia" classname="org.apache.velocity.anakia.AnakiaTask">
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </taskdef>
    <anakia basedir="${test.home}/anakia/xdocs" destdir="${test.target}/anakia"
            extension=".html" style="./site.vsl"
            projectFile="./stylesheets/project.xml"
            excludes="**/stylesheets/**"
            includes="**/*.xml"
            templatePath="${test.home}/anakia/xdocs/stylesheets"
            velocityPropertiesFile="${test.home}/anakia/velocity.properties"
            lastModifiedCheck="false">
    </anakia>
  
    <anakia basedir="${test.home}/anakia/xdocs" 
            destdir="${test.target}/anakia"
        extension=".context.html" style="./site_contexts.vsl"
        projectFile="./stylesheets/project.xml"
        excludes="**/stylesheets/**"
        includes="**/*.xml"
        templatePath="${test.home}/anakia/xdocs/stylesheets"
        lastModifiedCheck="false">
        
        <context name="customContext" file="./stylesheets/customContext.xml"/>
    </anakia>    
 
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}" >
      <arg value="org.apache.velocity.test.AnakiaTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-configuration">
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}" >
      <arg value="org.apache.velocity.test.ConfigurationTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

 <target name="test-commonsextprop">
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}" >
      <arg value="org.apache.velocity.test.CommonsExtPropTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <target name="test-externallogger">
    <echo message="Running external logger tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ExternalLoggerTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
   </target>


  <target name="test-methodinvocationexception">
    <echo message="Running MethodInvocationException tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.MethodInvocationExceptionTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
   </target>

   <target name="test-misc">
    <echo message="Running misc tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.MiscTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

   <target name="test-parser">
    <echo message="Running special parser tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ParserTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

   <target name="test-arithmetic">
    <echo message="Running special arithmetic tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ArithmeticTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

   <target name="test-number-methods">
    <echo message="Running number method call tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.NumberMethodCallsTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

  <!-- ================================================================ -->
  <!-- T E X E N  T E S T                                               -->
  <!-- ================================================================ -->
  <!-- Generate turbine service code via Texen                          -->
  <!-- ================================================================ -->

  <target name="test-texen">

    <taskdef name="texen" classname="org.apache.velocity.texen.ant.TexenTask">
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </taskdef>

    <texen
      contextProperties="${test.home}/texen/service-ant.props,${test.home}/texen/additional.props"
      controlTemplate="Control.vm"
      outputDirectory="${test.target}/texen"
      templatePath="${test.home}/texen/templates"
      outputFile="report"
    />

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.TexenTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>

  </target>

  <!-- ================================================================ -->
  <!-- T E X E N  C L A S S P A T H                                     -->
  <!-- ================================================================ -->
  <!-- Generate turbine service code via Texen with all the templates   -->
  <!-- and ancillary files in a JAR.                                    -->
  <!-- ================================================================ -->

  <target name="test-texen-classpath">

    <!--  note: previously the taskdef included the mysterious attribute reverseLoader="true" -->
    <!--  now that this has been removed, we only guarantee this works with ant 1.5+ -->
    <taskdef name="texen" classname="org.apache.velocity.texen.ant.TexenTask"
       >
      <classpath>
        <pathelement location="${test.home}/texen-classpath/test.jar"/>
        <path refid="classpath"/>
      </classpath>
    </taskdef>

    <texen
      useClassPath="true"
      contextProperties="service-ant.props"
      controlTemplate="Control.vm"
      outputDirectory="${test.target}/texen-classpath"
      outputFile="report"
    />

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.TexenClasspathTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>

  </target>

  <target name="test-multiloader">
    <echo message="Running MultiLoader tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.MultiLoaderTestCase"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement location="${test.home}/multiloader/test1.jar"/>
      </classpath>
    </java>
  </target>

 <target name="test-velocimacro">
    <echo message="Running Velocimacro tests..."/>
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.VelocimacroTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

 <target name="test-resourceinstance">
    <echo message="Running Resource Loader instance tests..."/>
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ResourceLoaderInstanceTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

 <target name="test-foreach">
    <echo message="Running Foreach max loops tests..."/>
    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.ForeachTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
  </target>

 <target name="test-includeeventhandler">
    <echo message="Running IncludeEvent Handler tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.IncludeEventHandlingTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
   </target>
   
 <target name="test-filteredeventhandler">
    <echo message="Running Filtered Event Handler tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.FilteredEventHandlingTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
 </target>

 <target name="test-builtineventhandler">
    <echo message="Running Built-In Event Handler tests..."/>

    <java classname="${velocity.test.runner}" fork="yes" dir=".." failonerror="${testbed.failonerror}">
      <arg value="org.apache.velocity.test.BuiltInEventHandlerTestCase"/>
      <classpath>
        <path refid="classpath"/>
      </classpath>
    </java>
   </target>

</project>
